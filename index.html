<!DOCTYPE html>
<html>
  <head>
    <title>Static Site Output</title>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css" />

    <style type="text/css">
      html, body, #map {
        height: 100%;
        margin: 0px;
        font-family: Helvetica, sans-serif;
      }

      #info {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 2000;
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.5);
        width: 250px;
        padding: 10px;
      }

      output {
        display: block;
        font-size: 1.5em;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="info">
      X/Y
      <output id="location"></output>
      Jobs within 60 minutes
      <output id="access"></output>
    </div>

    <script src="https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js"></script>
    <script src="node_modules/babel-polyfill/dist/polyfill.js"></script>
    <script src="build/index.js"></script>
    <script>
      var fetch = require('isomorphic-fetch')
      var Browsochrone = require('browsochrones').default

      var bc = new Browsochrone()

      var baseUrl = 'http://localhost:4567'
      var gridUrl = 'http://s3.amazonaws.com/analyst-static/indy-baseline/grids'

      Promise
        .all([
          fetch(`${baseUrl}/query.json`).then(res => res.json()),
          fetch(`${baseUrl}/stop_trees.dat`).then(res => res.arrayBuffer()),
          fetch(`${gridUrl}/Jobs_total.grid`).then(res => res.arrayBuffer())
        ])
        .then(res => {
          bc.setQuery(res[0])
          bc.setStopTrees(res[1])
          bc.setGrid(res[2])
        })
        .catch(e => {
          console.error(e)
          console.error(e.stack)
        })

      var isoLayer = null

      var map = window.L.mapbox
        .map('map', 'conveyal.hml987j0', {
          accessToken: 'pk.eyJ1IjoiY29udmV5YWwiLCJhIjoiY2lndnI5cms4MHJ4Mnd3bTB4MzYycDc4NiJ9.C40M0KSYXGSX_IbbqN53Eg',
          tileLayer: {
            maxZoom: 18
          }
        })
        .setView([39.766667, -86.15], 12)

      map.on('click', function (e) {
        // get the pixel coordinates
        var origin = bc.pixelToOriginCoordinates(map.project(e.latlng), map.getZoom())
        document.getElementById('location').value = `${origin.x | 0} / ${origin.y | 0}`

        if (!bc.coordinatesInQueryBounds(origin)) {
          if (isoLayer) {
            map.removeLayer(isoLayer)
            isoLayer = null
          }
          return
        }

        console.time('fetching origin')
        fetch(`${baseUrl}/${origin.x | 0}/${origin.y | 0}.dat`)
          .then(res => res.arrayBuffer())
          .then(origin => {
            console.timeEnd('fetching origin')
            bc.setOrigin(origin)

            console.time('generating surface')
            bc.generateSurface()
            console.timeEnd('generating surface')

            // Set the access output
            document.getElementById('access').value = bc.getAccessibilityForCutoff()

            if (isoLayer) map.removeLayer(isoLayer)

            isoLayer = window.L.tileLayer.canvas()
            isoLayer.drawTile = bc.drawTile.bind(bc)
            isoLayer.addTo(map)
          })
          .catch(err => {
            if (isoLayer) {
              map.removeLayer(isoLayer)
              isoLayer = null
            }

            console.error(err)
            console.error(err.stack)
          })
      })
    </script>
  </body>
</html>